---
title: Git简明教程
tags: Tools
categories: git
abbrlink: 6326f1e4
date: 2018-03-10 22:29:11
---

### Git简介

Git是目前世界上最先进的分布式版本控制系统。在Git出现之前，版本控制系统主要是集中式占据着绝对的统治地位，以CVS和SVN为代表。集中式版本控制系统中版本库集中存放在中央服务器，写代码的时候我们要先从中央服务器拉取最新版本，开发完成之后再讲版本推送到中央服务器，这就意味着必须联网才能工作，也存在代码丢失的风险。分布式版本控制系统去掉了中央服务器的概念，每个开发人员本地都有一份完整的版本库，在没有网络时也能进行开发工作。虽然分布式版本控制系统中去掉了中央服务器，但是为了协同开发人员之间的工作，通常会有一台充当“中央服务器”的电脑。如果不想搭建自己的gitlab服务器，可以选择第三方代码仓库，如github、coding.net、git.oschina等。

### 配置

因为Git是分布式版本控制系统，在将代码push到远程仓库时，需要告诉仓库提交者的身份。所以在安装完Git之后需要进一步配置，在命令行输入：

```shell
$ git config --global user.name "Your Name"
$ git config --global user.email "email@example.com"
```

注意`git config`命令的`--global`参数表示本机中的所有Git仓库都会使用这个配置，若想只针对当前仓库进行配置可以去掉`--global`参数。

<!--more-->

### 版本库

#### 创建版本库

版本库又叫仓库，可以简单的理解成一个目录，这个目录里面的所有文件都可以被Git管理起来，每个文件的修改、删除Git都能跟踪，以便在将来的某个时候将文件还原回之前的版本。创建版本库时，首先将路径切换到目标目录，执行：

```shell
$ git init
Initialized empty Git repository in C:/Users/windylee/Desktop/repository/.git/
```

这时该目录就会成为Git的一个本地仓库。这是在当前目录下就会多一个`.git`的目录，这个目录就是Git用来跟踪管理版本库的，千万不要手动修改这个目录里面的文件。

#### 将文件添加到版本库

Git只能跟踪文本文件的改动，比如txt、网页、程序代码等等，二进制文件虽然也能有Git管理，但是不能跟踪文件的变化。进入我们的本地仓库，创建一个`readme.txt`文件，在里面随便写点内容保存。

第一步，用命令`git add`告诉Git，把文件添加到仓库：

```shell
$ git add readme.txt
```

第二步，用命令`git commit`告诉Git，把文件提交到仓库:

```shell
$ git commit -m "write a readme.txt file"
[master (root-commit) 096895b] write a readme.txt file
 1 file changed, 1 insertion(+)
 create mode 100644 readme.txt
```

`-m`后面输入的是本次提交的说明，可以输入任意内容，但最好可以描述本次修改的内容，引文输入说明对自己对别人阅读都很重要。`commit`命令输出：第一行给出了本次commit的hash值，剩下的内容描述本次修改的内容（修改了1个文件，在该文件中插入了两行）。

如果本次修改文件过多，不想一个个add文件，可以通过命令：

```shell
$ git add --all
```

这条命令会将所有修改的文件一次全部添加到仓库。

### 版本控制

#### 查看状态

```shell
$ git status
On branch master
Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git checkout -- <file>..." to discard changes in working directory)

        modified:   readme.txt

no changes added to commit (use "git add" and/or "git commit -a")
```

通过`git status`命令我们可以时刻掌握仓库的当前状态，上面的命令告诉我们readme.txt文件被修改过了，但是还没有添加到仓库。在每次执行Git命令前运行该命令是一个较好的习惯。

如果修改内容过多，时间长了我们就不知道修改了文件的哪些内容。这是可以通过`git diff`命令来查看文件修改的内容

```shell
$ git diff readme.txt
diff --git a/readme.txt b/readme.txt
index 8f6e0fc..9468d46 100644
--- a/readme.txt
+++ b/readme.txt
@@ -1 +1,2 @@
 Git is a version control system
+happy coding.
```

显示的内容是本地文件与版本库中文件的difference，显示的格式正是Unix通用的diff格式。

#### 版本回退

```shell
$ git log
commit 3703210c919521c63f457341419b6daa3f38083f
Author: windylee <liwangadd@gmail.com>
Date:   Fri Jan 12 13:52:29 2018 +0800

    add happy coding line

commit 096895bbf40546221e12c16a4ea1a77d6565b16e
Author: windylee <liwangadd@gmail.com>
Date:   Fri Jan 12 13:32:28 2018 +0800

    write a readme.txt file
```

`git log`命令显示从最近到最远的提交日志，可以看到我们总共有两次提交。如果嫌输出信息太多，可以加上`--pretty=oneline`参数，一次提交日志就会在一行显示：

```shell
$ git log --pretty=oneline
3703210c919521c63f457341419b6daa3f38083f add happy coding line
096895bbf40546221e12c16a4ea1a77d6565b16e write a readme.txt file
```

如果我们想返回上一个版本，可以使用如下命令：

```shell
$ git reset --hard HEAD^
```

若要返回上一个版本，首先要先知道当前版本是哪个版本。在Git中，用`HEAD`表示当前版本，上一个版本就是`HEAD^`，上上个版本就是`HEAD^^`。如果要返回上100各版本怎么办，由于每次commit都会产生一个hash值作为本次提交的唯一标识，可以将`HEAD^`换成会返回版本的hash值(取前7位即可)。

```shell
git reset --hard 3703210
```

#### 暂存区

创建仓库之后，目录中会多出`.git`目录。该目录就是Git的版本库，其中包括成为stage的暂存区，还有自动创建的master分支以及指向master的HEAD指针。在执行`git add`命令时，是将文件修改添加到暂存区，执行`git commit`命令则是将暂存区中的内容提交到当前分支并将暂存区清空。

#### 撤销修改

```shell
$ git checkout --readme.txt
```

命令`git checkout -- filename`会把文件在工作区的修改全部撤销，若文件修改后还没有添加到暂存区，撤销修改就回到和版本库一样的状态；若文件已经添加到暂存区，之后又做了修改，撤销修改就回到添加到暂存区后的状态。

若文件修改已添加到暂存区，而要删除暂存区中的文件修改内容。可以使用如下命令：

```shell
$ git reset HEAD readme.txt
```

该命令可以把暂存区的修改撤销掉，重新放回工作区。

#### 删除文件

在Git中，删除也是一种修改操作。可以直接在文件管理器中将文件删除，这时工作区和版本库就不一致了。可以选择从版本库中删除该文件，使用`git rm`将文件从版本库删除掉，并且`git commit`。或者是误删，这是可以将文件从版本库中回复到最新版本：

```shell
git checkout -- readme.txt
```

`git checkout`是用版本库里的版本替换工作区的版本，无论工作区是修改还是删除，都可以“一键还原”。

### 远程仓库

#### 添加远程仓库

在我们开发时，通常将代码托管到github上。这样，github上的仓库既可以作为备份，又可以让其他人通过该仓库来协作。在github上创建一个新仓库之后，在本地仓库下运行如下命令：

```shell
$ git remote add origin git@github.com:liwangadd/repository.git
```

这是本地仓库就将github上的相应仓库作为托管平台。下一步就可以把本地库的所有内容推送到远程库上：

```shell
$ git push -u origin master
```

由于远程仓库是空的，我们第一次推送master分支时，加上`-u`参数。Git不但会把本地的master分支内容推送到远程新的master分支，还会把本地的master分支和远程的master分支关联起来。

#### 从远程库克隆

进入到我们想要克隆到本地的项目主页，获取到仓库地址。使用如下命令将远程仓库clone到本地：

```shell
$ git clone https://github.com/yaochenkun/aiop-notice.git
```

如果有多个人协作开发，那么每个人各自从远程clone一份就可以了。

### 分支管理

#### 创建与合并分支

创建`dev`分支，然后切换到`dev`分支：

```shell
$ git checkout -b dev
Switched to a new branch 'dev'
```

`git checkout`命令加上`-b`参数表示创建并切换分支，相当于以下两条命令：

```shell
$ git branch dev
$ git checkout dev
Switched to a new branch 'dev'
```

然后就可以用`git branch`命令查看当前分支

```shell
$ git branch
* dev
  master
```

`git branch`命令会列出所有分支，当前分支前面会标一个`*`号

`git merge`命令用于合并指定分支到当前分支：

```shell
$ git merge dev
Updating d17efd8..fec145a
Fast-forward
 readme.txt |    1 +
 1 file changed, 1 insertion(+)
```

注意到上面的`Fast-forward`信息，Git告诉我们，这次合并是"快进模式"，也就是直接把`master`指向`dev`的当前提交。但是在这种模式下，删除分之后，会丢掉分支信息。如果强制禁用`Fast-forward`模式，Git就会在merge时生成一个新的commit，这样从分支历史上就可以看出分支信息。强制禁用`Fast-forward`模式，可以使用`--no-off`参数，因为合并会创建一个新的commit，所有加上`-m`参数，把commit描述写进去。

```shell
$ git merge --no-ff -m "merge with no-ff" dev
```

分支合并完成后，如果dev分支不需要了，可以将该分支删除:

```shell
git branch -d dev
```

因为创建、合并和删除分支非常快，所以当我们要完成某个任务时，可以先创建分支，在新的分支上开发完成再合并到主分支。

#### Bug分支

若当前正在dev分支上进行工作，需要切换到其他分支工作，而dev分支上的任务还没有完成，不能提交到暂存区。这时可以使用`stash`功能，可以把当前工作现场“储藏”起来，等以后恢复现场后继续工作。

```shell
$ git stash
Saved working directory and index state WIP on dev: 3703210 add happy coding line
HEAD is now at 3703210 add happy coding line
```

这是就可以切换到其他分支进行工作了，工作完成回到该分支，可以使用`git stash list`命令查看工作现场。

```shell
$ git stash list
stash@{0}: WIP on dev: 3703210 add happy coding line
```

可以看到，工作现场还在。Git把stash内容存在了某个地方了，若要将stash的内容恢复到工作区，有两个办法：

- 用`git stash apply`恢复，但是恢复后，stash内容并不删除，需要用`git stash drop`来删除
- 用`git stash pop`，恢复的同时把stash内容删了

若执行了多次stash，恢复的时候，先用`git stash list`查看，然后恢复指定的stash，用命令：

```shell
$ git stash apply stash@{0}
```

#### 强行删除分支

如分支没有合并，使用`git branch -d dev`命令会提示分支没有合并，删除失败。如果要强行删除，需要使用命令`git branch -D dev`。

```shell
$ git branch -D dev
Deleted branch dev (was 3703210).
```

#### [多人协作](https://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/0013760174128707b935b0be6fc4fc6ace66c4f15618f8d000)

### 标签管理

发布一个版本时，我们通常现在版本库中打一个标签，这样唯一确定了打标签时刻的版本。将来无论什么时候，取某个标签的版本，就是把那个打标签的时刻的历史版本取出来。所以标签也是版本库的一个快照，其实就是指向某个commit的指针。由于commit给出的是一个hash值，不好记忆，所以才引入了标签这个概念。

#### 创建标签

使用`git tag <name>`命令可以打一个标签：

```shell
$ git tag v1.0
```

可以用命令`git tag`查看所有标签。默认标签是打在最新提交的commit上的，若想打在之前某个commit上面，就需要根据历史提交的commit id打标签：


