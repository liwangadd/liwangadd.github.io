---
title: Spring定时任务
tags: [Spring, Java]
categories: Java
abbrlink: 4016a806
date: 2018-02-20 22:53:46
---

关于spring的定时任务，我们在spring3.0之前一般会使用Quartz，这是一个功能相当强大的调度器，可以让你的程序在指定时间执行，也可以按照某个频度执行，但是配置起来稍显复杂。Spring3.0以后自带task，可以将它看成一个轻量级的Quartz，使用起来比Quartz简单许多，不需要额外的包，而且支持注解和配置文件两种形式。
#### 基本使用
##### 配置文件方式
首先需要在配置文件中引入task命名空间
```xml
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:task="http://www.springframework.org/schema/task"
    ...
    http://www.springframework.org/schema/task
    http://www.springframework.org/schema/task/spring-task.xsd">
```
然后配置需要定时执行的任务
```xml
	<!--Spring定时器注解开关，注册之后可以再java类中使用task命名空间的注解-->
	<task:annotation-driven scheduler="myScheduler"/>
    <!--内部使用的线程池，配置线程池，指定线程池的大小-->
    <task:scheduler id="myScheduler" pool-size="10>
    <!--配置定时任务，指定需要定时执行的类和方法，并配置调度方式-->
    <task:scheduled-task scheduler="myScheduler">
    	<task:scheduled ref="scheduledTaskManager" method="autoCardCalculate" cron="0 5 * * * *"/>
    </task:scheduled-task>
```

<!--more-->

##### 注解形式
首先我们看一下源码中注解的定义
```java
@Target({ElementType.METHOD, ElementType.ANNOTATION_TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Repeatable(Schedules.class)
public @interface Scheduled {
    String cron() default "";

    String zone() default "";

    long fixedDelay() default -1L;

    String fixedDelayString() default "";

    long fixedRate() default -1L;

    String fixedRateString() default "";

    long initialDelay() default -1L;

    String initialDelayString() default "";
}
```
我们可以看到该注解有八个参数，分别表示的意思是：
cron：指定cron表达式
zone：指定时区
fixedRate：从上一个任务开始到下一个任务开始的间隔，单位是毫秒
fixedDelay：从上一个任务完成到下一个任务开始的间隔，单位是毫秒
initialDelay：任务第一次执行前需要延迟的毫秒数
这些配置参数都可以在xml配置文件中使用，效果是一样的
##### 执行任务的POJO类
```java
public class ScheduledTaskManager{

	/**
     * 每日凌晨2点执行一次
     */
    @Scheduled(cron = "0 0 2 * * *")
    public void autoCardCalculate() {
        System.out.println("hello world" + new Date());
    }

    /**
     * 心跳更新，启动时执行一次，之后每隔一分钟执行一次
     */
    @Scheduled(fixedRate = 1000 * 60)
    public void heartbeat() {
        System.out.println("hello world" + new Date());
    }

    /**
     * 启动后一秒钟之后执行一次，之后每次执行完间隔2分钟执行一次
     */
    @Scheduled(fixedDelay = 1000 * 60 * 2, initialDelay = 1000)
    public void persistRecord() {
        System.out.println("hello world" + new Date());
    }
}
```
##### 组合多个Scheduled
@Scheduled可以让我们很方便的配置定时任务，但是有的定时任务不是一个表达式就能表达完全的，比如说我既想在周三10:10又想在周四17:40执行某项任务。这时候我们很难用一个表示式，或者根本行不通，这时候我们就要组合多个@Scheduled表达式。
@Schedules注解里面只有一个参数Scheduled数组，意味着我们可以将多个@Scheduled压入数组，组合使用
```java
//每隔18秒执行一次，并且每天的4:00执行一次
@Schedules({@Scheduled(cron = "* * 4 * * *"),@Scheduled(fixedRate = 1000*18)})
```
#### cronExpression的配置说明
##### 各字段意义

字段        | 允许值      |允许的特殊字符
-----------|------------|------------
秒          | 0-59      | , - * /
分          | 0-59      | , - * /
小时        | 0-23       | , - * /
日期        | 1-31       | , - * /
月份        | 1-12或JAN-DEC| , - * /
星期        | 1-7或SUN-SAT        | , - * /
年（可选）   | 留空，1970-2099 | , - * /
`-` 指定区间
`*` 通配符
`?` 你不想设置那个值
`/` 没多少执行一次
##### 例子
CRON表达式     | 含义
--------------|---------------
`0 0 12 * * ?`| 每天中午12点触发
`0 15 10 ? * *`|每天上午10:15触发
`0 15 10 * * ?`|每天上午10:15触发
`0 15 10 * * ? *`| 每天上午10:15触发
`0 15 10 * * ? 2015`| 2015年的每天上午10:15触发
`0 * 14 * * ?`| 每天下午14:00到14：59每分钟触发一次
`0 0/5 14 * * ?`|每天下午14:00到14:55没5分钟触发一次
`0 0/5 14,18 * * ?`|每天14:00到14:55和18:00到18:55每5分钟触发一次
`0 0-5 14 * * ?`| 每天14:00前五分钟每分钟触发一次
`0 10,44 14 ? 3 WED`|3月每周三14:10和14:44触发
`0 15 10 ? * MON-FRI`|周一到周五的10:15触发