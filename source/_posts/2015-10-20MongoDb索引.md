---
title: MongoDb索引
tags: [MongoDb]
categories: 数据库
abbrlink: c2f6f9e3
date: 2015-10-20 15:49:29
---

#### 索引简介
索引是用来加速查询的，类似于数的目录一样。我们要查找某些内容不需要查遍整个数据库，只需要先在索引中查找，找到相应索引之后根据索引找到指向的文档。
创建索引使用ensureIndex函数，`db.people.ensureIndex({'username':1})`,1代表对索引内容进行正向排序，-1代表对索引内容逆向排序。对某个键创建的索引会加速以该键为查询条件的查询，对其他查询没有帮助。索引创建既可以针对单个键创建也可以针对多个键创建，例如`db.people.ensureIndex({'name':1,age:-1,'sex':1})`其作用原理与sort相同(由前到后逐个匹配)。如果创建了我们上面所看到的索引实际上是有了`{name:1}`,`{name:1,age:-1}`,`{name:1,age:-1,sex:1}`三个索引，使用{age:-1}等索引的查询不会得到优化。
创建索引并不是只有优点的，他的缺点就是每次插入，更新，删除都会产生额外的开销用来更新索引。所以我们要根据实际情况合理的创建索引，通常我们要考虑实际情况中都需要经常对哪些键查询，然后对该查询字段创建索引，每个集合的最大索引个数为64个
##### 注意索引顺序
当我们创建多键索引时要分清主次，一般我们可以这样认为，当根据我们创建的多键索引进行查询时会先根据前面的条件筛选，将结果用于下一次筛选。所以创建多键索引时我们要将主要索引条件放在前面，建立索引时要考虑如下问题：
1. 会做什么样的查询，其中哪些键需要索引
2. 每个键的索引方向是怎样的
3. 如何应对拓展，有没有种不同的键的排列可以是常用数据更多地保存在内存中

<!--more-->

##### 索引内嵌文档
为内嵌文档建立索引和为普通的键创建索引没有什么区别，只是在索引内嵌文档的字段的时候使用**点表达式**，也可以和普通键索引组成复合索引
##### 为排序创建索引
随着集合的增长，需要针对大量的排序做索引。因为如果排序实在内存中完成的，如果数据量特别大超出内存的限制就是报错。如果没有对数据进行sort，默认就是查询出来的顺序，所以创建索引之后查询出来的顺序就是排序之后的结果
##### 索引名称
每一个索引都有一个字符串类型的名字用来唯一标示，数据库通过这个名字来删除或操作索引。默认情况索引名类似keyname1_dir1_keyname2_dir2...形式（keynameX代表索引的键，dirX代表索引的方向）。我们可以通过ensureIndex的第二个参数来指定索引的名字
```js
db.people.ensureIndex({'name':1,'age':-1},{'name':'index1'})
```
#### 唯一索引
唯一所以可以确保集合的每一个文档的指定键都有唯一的值，相当于关系型数据库中的unique键。要创建唯一索引需要在ensureIndex的第二个参数中指定unique为true。在创建集合是自动给我们创建了`_id`唯一索引，与普通唯一索引的区别是不能被删除
```js
db.people.ensureIndex({'username':1},{'unique':true})
```
可能当我们创建唯一索引的时候，有些值已经有重复了，这时候索引的创建就会失败。但是我们可以使用dropDups选项，这样可以保留发现的第一个文档，将其他重复文档删除
```js
db.people.ensureIndex({'username':1},{'unique':true, 'dropDups':true})
```
创建符合唯一索引的时候，单个键的值可以相同，只要所有键的值组合起来不同就好
#### 强制使用索引
如果发现MongoDb没有使用预期的索引，可以用hint强制使用某个索引。例如希望使用`{'username':1,'age':1}`索引
``` js
db.people.find({'age':14,'username':'nicolas'}).hint({'username':1,'age':1})
```
多数情况下并没有这么做的必要，MongoDb会非常智能的选择使用哪个索引。在初次查询时会尝试各种查询方案，最优方案会被记录下来，还会定期重试其他方案，防止建立新的索引之后方案不再是最优
#### 索引管理
索引的原信息存储在每个数据库的system.indexes集合中，不能对该集合插入或删除文档，操作只能通过ensureIndex和dropIndex进行
建立索引既耗时有费力，还需要消耗很多资源，可以使用`{'background':true}`选项是这个过程在后台完成，同时正常处理请求。一般来说为已有文档创建索引比先创建索引再插入所有文档要稍快一些。不管怎么说在无关紧要的时刻创建索引是最好的选择
当索引没用的时候可以通过dropIndex选项删除索引,删除依据是创建索引的条件
```js
db.people.dropIndex({'username':1,'age':-1})
```
#### 地理空间索引
MongoDb为坐标平面提供了专门的索引成为地理空间索引，可以找出离某一坐标平面最近的点。创建地理空间索引同样适用ensureIndex选项，只不过参数不是1或-1而是2d。建立索引的键的值必须是包含两个元素的数组或包含两个键的内嵌文档(键名可以随意)。地理空间索引默认的范围是180·-180，如果想要指定大小可以使用第二个参数
```js
db.start.insureIndex({'light-year':'2d'},{'min':-1000,'max':1000})
```
地理空间索引的查询和普通的find查询差别不大，只不过使用了`$near`，需要两个目标值的数组作为参数，默认返回100个距离给点坐标最近的文档，可以使用limit进行限制。还可以使用`$maxDistance`限定查询的最大距离
```js
db.map.find({'gps':{$near:[40,-73], $maxDistance:40}}).limit(10)
```
MongoDb不仅可以根据距离查询，还可以根据形状查询，目前支持矩形,圆形查询和多边形查询，需要用到`$within`
```js
//要给出矩形左上角和右下角坐标
db.map.find({'gps':{$within:{$box:{[10,30],[15,40]}}}})
//需要圆的原点坐标和半径
db.map.find({'gps':{$within:{$circle:{[10,20],40}}}})
//多边形各个点的坐标
db.map.find({'gps':{$within:{$polygon:[[1,2],[1,4],[6,3]]}}})
```
我们可以组合地理空间索引和普通索引，这样可以满足继续要地里空间限制条件组合普通限制条件的查找
```js
db.ensureIndex({'location':'2d','desc':1})
```

